
# Manually update MCP (MachineConfigPool)

Node in degraded state because of the use of a deleted machineconfig.

Cluster node is showing `machineconfig.machineconfiguration.openshift.io "rendered-master-xxxx" not found` error message in the node description output.

## Diagnostic Steps

- Check the mcp (MAchineConfigPool). The following message shows that the rendered mc (MachineConfig) used is not found.
```
$ oc get mcp
NAME     CONFIG                 UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT
master   rendered-master-xxxx   False      False      True      3              0                   0                     3

$ oc describe mcp master
....
Message:               Node master0.cluster.domain is reporting: "machineconfig.machineconfiguration.openshift.io \"rendered-master-xxxx\" not found"
    Reason:                3 nodes are reporting degraded status on sync
....
```


- Check the logs of the machine-config-operator and machine-config-daemon of the degraded node.
```
$ oc get pods -n openshift-machine-config-operator -o wide
$ oc describe pod machine-config-daemon-tbkwe -n openshift-machine-config-operator
$ oc describe pod machine-config-operator-51b98di73q-bg38i -n openshift-machine-config-operator
```


- Check the node annotations `machineconfiguration.openshift.io/currentConfig` and `machineconfiguration.openshift.io/desiredConfig`. The values should be same and those of the existed machineconfig.
```
$ oc describe node master0.cluster.domain | grep -i config
....
machineconfiguration.openshift.io/currentConfig: rendered-master-xxxx not found
machineconfiguration.openshift.io/desiredConfig: rendered-master-xxxx not found
machineconfiguration.openshift.io/reason: <some reason>
machineconfiguration.openshift.io/state: Degraded
....
```


## Root Cause
The node annotations `machineconfiguration.openshift.io/currentConfig` or `machineconfiguration.openshift.io/desiredConfig` point to a machineConfig that no longer exists, and the `machine-config-operator` can not process that request.


## Resolution
The node annotation `machineconfiguration.openshift.io/desiredConfig` is generated by the `machine-config-controller`, and there is no way to **update** it other than having the controller re-render manually(rendered-config-xxx describes the state of a system). The `machine-config-controller` is not able to understand what the config needs to be since the rendered-config is an aggregate of all machineConfigs assigned to that nodeSelector.

- Assumptions.
```
Working mc: rendered-master-55f7c69f13e362ebcff5f90c7085aa2a
Missing mc: rendered-master-47daa0aaf2aac3477b7dcc774945374a
```


1. Export the existing mc.
```
$ oc get mcp
NAME     CONFIG                                             UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT
master   rendered-master-47daa0aaf2aac3477b7dcc774945374a   False      False      True      3              0                   0                     3

$oc get mc
NAME                                               GENERATEDBYCONTROLLER
....
rendered-master-55f7c69f13e362ebcff5f90c7085aa2a   e54335a3855fc53597e883ba98b548add39a8938
....

$ oc get mc rendered-master-55f7c69f13e362ebcff5f90c7085aa2a -o yaml > mymc.yaml
```


2. Edit mymc.yaml and replace all of the values related to the existing mc with the missing mc values.
```
$ vi mymc.yaml
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  annotations:
    machineconfiguration.openshift.io/generated-by-controller-version: e54335a3855fc53597e883ba98b548add39a8938
    machineconfiguration.openshift.io/release-image-version: 4.12.30
  creationTimestamp: "2024-04-01T06:59:36Z"    <----- delete this line
  generation: 1                                <----- delete this line
  name: rendered-master-ee37d00cb0f68430f42c1015fedb8fb5  <----- replace this value with rendered-master-47daa0aaf2aac3477b7dcc774945374a
  ownerReferences:
  - apiVersion: machineconfiguration.openshift.io/v1
    blockOwnerDeletion: true
    controller: true
    kind: MachineConfigPool
    name: master
    uid: 53860789-d7aa-4fbb-a7fc-1ff31b249882  <----- don't delete this
  resourceVersion: "11307"
  uid: f12c80f0-48c8-4003-b25b-3405631dedd4    <----- delete this line
spec:
  baseOSExtensionsContainerImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:ebfc5c69cc49f5f1547eecba53ac5bcb9817efc51ecf7e2c608977ea36ff88ae
  config:
....
```


3. Create the missing mc and check if it got created.
```
$ oc create -f mymc.yaml
$ oc get mc | grep rendered-master-47daa0aaf2aac3477b7dcc774945374a
```


